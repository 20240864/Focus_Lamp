# 色温与亮度控制：从开尔文到RGB的转换

本文档旨在详细解释如何通过RGB数值来模拟不同的色温（单位：开尔文, K），以及如何独立控制LED灯带的亮度。

## 1. 理解色温 (Color Temperature)

色温是衡量光源颜色特性的一个重要指标，它基于黑体辐射理论。简单来说：

- **低色温 (暖色)**: 趋向于红色、橙色和黄色，如烛光或日出（约1850K-3500K）。<mcreference link="https://github.com/RobTillaart/Kelvin2RGB" index="4">4</mcreference>
- **高色温 (冷色)**: 趋向于白色和蓝色，如正午的日光或阴天（约5000K-10000K）。<mcreference link="https://academo.org/demos/colour-temperature-relationship/" index="1">1</mcreference>

在LED灯带上，我们可以通过精确混合红、绿、蓝三种颜色的比例来模拟出不同色温的光。

## 2. 从开尔文到RGB的转换算法

将色温（K）直接转换为RGB值并不存在一个完美的线性公式，因为这涉及到人眼的感知和复杂的物理模型。然而，我们可以使用一些经过优化的近似算法来获得非常接近的效果。其中，由Tanner Helland提出的算法因其简洁和良好的效果而被广泛应用。<mcreference link="https://tannerhelland.com/2012/09/18/convert-temperature-rgb-algorithm-code.html" index="3">3</mcreference> <mcreference link="https://github.com/RobTillaart/Kelvin2RGB" index="4">4</mcreference> <mcreference link="https://www.npmjs.com/package/color-temperature" index="5">5</mcreference>

该算法主要分为以下几个步骤：

### 步骤 1: 准备工作

1.  **输入**: 色温值 `temp` (范围建议在 1000K 到 40000K 之间)。<mcreference link="https://tannerhelland.com/2012/09/18/convert-temperature-rgb-algorithm-code.html" index="3">3</mcreference>
2.  **预处理**: 将输入的色温值除以100，得到一个中间值 `temperature` 用于后续计算。

### 步骤 2: 计算红色 (R) 分量

-   如果 `temperature` <= 66:
    -   `red = 255`
-   如果 `temperature` > 66:
    -   `red = 329.698727446 * (temperature - 60)^-0.1332047592`
    -   将计算结果约束在0到255之间。

### 步骤 3: 计算绿色 (G) 分量

-   如果 `temperature` <= 66:
    -   `green = 99.4708025861 * ln(temperature) - 161.1195681661`
-   如果 `temperature` > 66:
    -   `green = 288.1221695283 * (temperature - 60)^-0.0755148492`
-   将计算结果约束在0到255之间。

### 步骤 4: 计算蓝色 (B) 分量

-   如果 `temperature` >= 66:
    -   `blue = 255`
-   如果 `temperature` <= 19:
    -   `blue = 0`
-   如果 `temperature` > 19 且 < 66:
    -   `blue = 138.5177312231 * ln(temperature - 10) - 305.0447927307`
-   将计算结果约束在0到255之间。

### Python 实现示例

```python
import math

def kelvin_to_rgb(temp_kelvin):
    """
    将开尔文色温转换为RGB颜色。
    算法来源: Tanner Helland
    """
    temp = temp_kelvin / 100.0
    
    # 计算红色分量
    if temp <= 66:
        red = 255
    else:
        red = 329.698727446 * ((temp - 60) ** -0.1332047592)
    
    # 计算绿色分量
    if temp <= 66:
        green = 99.4708025861 * math.log(temp) - 161.1195681661
    else:
        green = 288.1221695283 * ((temp - 60) ** -0.0755148492)
        
    # 计算蓝色分量
    if temp >= 66:
        blue = 255
    elif temp <= 19:
        blue = 0
    else:
        blue = 138.5177312231 * math.log(temp - 10) - 305.0447927307

    # 约束范围并返回整数
    return (
        int(max(0, min(255, red))),
        int(max(0, min(255, green))),
        int(max(0, min(255, blue)))
    )

# --- 示例 ---
warm_white = kelvin_to_rgb(3200)  # 暖白光, 约 (255, 209, 163)
neutral_white = kelvin_to_rgb(5000) # 中性白光, 约 (255, 243, 239)
cool_white = kelvin_to_rgb(6500)  # 冷白光, 约 (255, 255, 255)
```

## 3. 亮度和色温的结合控制

亮度和色温是两个独立但可以结合的属性。

1.  **先确定色温**: 使用 `kelvin_to_rgb()` 函数计算出目标色温对应的基础RGB值（此时亮度是最大的）。
2.  **再调整亮度**: 通过一个亮度因子（例如0.0到1.0）来等比例缩放RGB的三个分量，从而在不改变色相（颜色）的前提下，只改变其明暗程度。

### 亮度控制算法

```python
def set_brightness(rgb_color, brightness_factor):
    """
    调整RGB颜色的亮度。
    :param rgb_color: 一个 (R, G, B) 元组。
    :param brightness_factor: 亮度因子, 范围 0.0 (灭) 到 1.0 (最亮)。
    """
    r, g, b = rgb_color
    brightness_factor = max(0.0, min(1.0, brightness_factor))
    
    # 等比例缩放RGB分量
    adjusted_r = int(r * brightness_factor)
    adjusted_g = int(g * brightness_factor)
    adjusted_b = int(b * brightness_factor)
    
    return (adjusted_r, adjusted_g, adjusted_b)

# --- 示例 ---
base_rgb = kelvin_to_rgb(4000) # (255, 226, 201)

# 50% 亮度的4000K色温光
half_brightness_color = set_brightness(base_rgb, 0.5)
# 结果: (127, 113, 100)

# 10% 亮度的4000K色温光
low_brightness_color = set_brightness(base_rgb, 0.1)
# 结果: (25, 22, 20)
```

### 等价关系

-   **色温**: 决定了R, G, B三个通道之间的**比例关系**。
-   **亮度**: 决定了R, G, B三个通道数值的**整体大小**。

改变亮度时，我们保持RGB比例不变；改变色温时，我们改变RGB的比例关系。

## 4. 在Focus Lamp项目中的应用

你可以将上述函数集成到你的项目中，创建一个新的服务事件，例如 `temperature`，来控制灯光。

```python
# 在 RGBService 中增加一个处理函数

class RGBService(ServiceBase):
    # ... 其他代码 ...
    
    def handle_event(self, event_type: str, payload: Any):
        if event_type == "solid":
            self._handle_solid(payload)
        elif event_type == "paint":
            self._handle_paint(payload)
        elif event_type == "temperature": # 新增事件类型
            self._handle_temperature(payload)
        else:
            self.logger.warning(f"Unknown event type: {event_type}")

    def _handle_temperature(self, payload):
        # payload 可以是一个字典: {"kelvin": 4000, "brightness": 0.8}
        temp_k = payload.get("kelvin", 6500)
        brightness = payload.get("brightness", 1.0)
        
        base_rgb = kelvin_to_rgb(temp_k)
        final_rgb = set_brightness(base_rgb, brightness)
        
        self._handle_solid(final_rgb) # 复用solid模式来设置颜色

# --- 调用 --- 
# 设置一个4500K，70%亮度的灯光
rgb_service.dispatch("temperature", {"kelvin": 4500, "brightness": 0.7})
```

通过这种方式，你可以方便地通过色温和亮度这两个更符合直觉的参数来控制灯光，而不是直接操作底层的RGB值。